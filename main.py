import argparse
import os
import sys
import shutil
from src.graph import create_graph

def cleanup_artifacts():
    """
    Removes temporary folders created by HuggingFace/Training scripts
    to keep the project root clean.
    """
    # common folder names generated by HF Transformers/Trainers
    temp_folders = [
        "results", 
        "logs", 
        "wandb", 
        "checkpoints",
        "runs",
        "tmp_trainer",
        "cactus_model", 
        "cactus_classifier", 
        "bert_model",
        "temp_model",
        "__pycache__"
    ]
    
    for folder in temp_folders:
        if os.path.exists(folder):
            try:
                shutil.rmtree(folder)
                print(f"ğŸ§¹ Cleaned up temporary folder: {folder}")
            except Exception:
                pass

    if os.path.exists("temp_train.py"):
        os.remove("temp_train.py")
        print("ğŸ§¹ Removed temp_train.py")

def main():
    # 1. parse Arguments
    parser = argparse.ArgumentParser(description="MLEbench Autonomous Agent")
    parser.add_argument(
        "--dataset", 
        type=str, 
        required=True, 
        help="Path to the dataset directory (containing train.csv, images/, etc.)"
    )
    args = parser.parse_args()

    dataset_path = os.path.abspath(args.dataset)
    
    # 2. validation
    if not os.path.exists(dataset_path):
        print(f"âŒ Error: Dataset path '{dataset_path}' does not exist.")
        sys.exit(1)

    print(f"ğŸš€ Starting Autonomous Agent on: {dataset_path}")
    print("---------------------------------------------------")

    # 3. setup Environment
    os.makedirs("submission", exist_ok=True)
    os.makedirs("logs", exist_ok=True)

    # delete previous submission folders to avoid confusion
    if os.path.exists("submission/submission.csv"):
        print("ğŸ—‘ï¸  Cleaning up previous submission.csv...")
        os.remove("submission/submission.csv")

    # 4. Initialize State
    initial_state = {
        "dataset_dir": dataset_path,
        "iteration": 0,
        "success": False,
        "reasoning_trace": []
    }

    # 5. build and Run Graph
    try:
        app = create_graph()
        final_state = app.invoke(initial_state)
        
        print("---------------------------------------------------")
        if final_state.get("success"):
            print("âœ… Mission Complete!")
            print(f"ğŸ“ Submission: {os.path.abspath('submission/submission.csv')}")
            print(f"ğŸ“„ README:     {os.path.abspath('submission/README.md')}")
        else:
            print("âš ï¸ Mission Failed (Max retries reached).")
            print("Check logs/ for details.")
    
    except Exception as e:
        print(f"âŒ Critical System Error: {str(e)}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
    finally:
        # 6. final Cleanup
        print("---------------------------------------------------")
        cleanup_artifacts()

if __name__ == "__main__":
    main()